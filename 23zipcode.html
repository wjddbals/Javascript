<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>자바스크립트 ajax-zipcode</title>
  </head>
  <body>
    <h1>자바스크립트 ajax-zipcode</h1>
    <p>
        1. tomcat.apache.org에서 tomcat 서버를 다운로드하고
        적당한 곳에서 압축해제해 둠<br>

        2. webapps/ROOT에 sido.jsp, gugun.jsp, dong.jsp에
        (:root/server안에는 sido,gugun,dong넝ㅎ고 root디렉토리에는
        :23zipcode.html을 넣어둠)
        복사해 둠 (23zipcode.html도 마찬가지!)<br>

        3. bin/startup.bat로 서버 시작해 둠<br>

        4. http://127.0.0.1:8080/server/sido.jsp로 실행 확인<br>

        5. 실습확인은 http://127.0.0.1:8080/23zipcode.html을 이용함<br>

        6. 선택한 시도에 대한 구군 조회는 'gugun.jsp?sido=시/도이름' 로 함<br>

        7. 선택한 시도와 구군에 대한 동 조회는
        'dong.jsp?sido=시/도이름&gugun=구/군이름' 으로 함
    </p>

  <div>
      <select id="sido"></select>
      <select id="gugun"></select>
      <select id="dong"></select>
  </div>

  <script>
      let url1='http://127.0.0.1:8080/server/sido.jsp';
      let url2='http://127.0.0.1:8080/server/gugun.jsp';
      let url3='http://127.0.0.1:8080/server/dong.jsp';

      let sido = document.querySelector('#sido');
      let gugun = document.querySelector('#gugun');
      let dong = document.querySelector('#dong');

      let makeopt =(elm,text) =>{
          let opt= document.createElement('option');
          let txt =document.createTextNode(text);
          opt.appendChild(txt);
          elm.appendChild(opt);

      }

      //1 시도 출력

      function setSido(sidos) {
          //응답데이터를 ,로 구분해서 배열에 저장
          let cols=sidos.split(',');

          makeopt(sido,'-광역시-');
          makeopt(gugun,'-시군구-');
          makeopt(dong,'-읍면동-');

          //기본 option 요소 추가


         /*
          let opt= document.createElement('option');
          let txt =document.createTextNode('-광역시-');
          opt.appendChild(txt);
          sido.appendChild(opt);

           opt= document.createElement('option');
           txt =document.createTextNode('-시/군/구-');
          opt.appendChild(txt);
          gugun.appendChild(opt);

            opt= document.createElement('option');
           txt =document.createTextNode('-읍/면/동-');
          opt.appendChild(txt);
          dong.appendChild(opt);*/

          //시도 option
          for (let  col of cols){
              if (col =='') continue;
            makeopt(sido,col);
          }
      }

      let getSido = () =>{
          let req=new XMLHttpRequest();
          req.onreadystatechange = () => {
              if(req.readyState==4&& req.status==200){
                  //console.log(req.responseText);
                  setSido(req.responseText);
              }
          };
          req.open('get',url1);
          req.send();

      };


      //시도 선택했을때 이벤트 처리
      sido.addEventListener('change',()=>{
          let qry ='?sido='+ sido.value;
          //선택한시도가 '광역시라면' 함수 실행중지
          if(sido.selectedIndex==0) return;

          let req=new XMLHttpRequest();
          req.onreadystatechange = () => {
              if(req.readyState==4&& req.status==200){
                  //console.log(req.responseText);
                  setGugun(req.responseText);


              }
          };
          req.open('get',url2+qry);
          req.send();
      });


      //2 구군 출력//  ///****

      const setGugun = (guguns) => {

         let  cols=guguns.split(',');
         while (gugun.lastChild) {
             gugun.removeChild(gugun.lastChild);
         }
          makeopt(gugun,'시군구');
          for (let  col of cols){
              if (col =='') continue;
              makeopt(gugun,col);
          }

      };

      //구군선태시 이벤트 처리//***

      gugun.addEventListener('change',()=>{


          let qry =`?sido=${sido.value}&gugun=${gugun.value}`;

          let req=new XMLHttpRequest();
          req.onreadystatechange = () => {
              if(req.readyState==4&& req.status==200){
                  //console.log(req.responseText);
                  setDong(req.responseText);


              }
          };
          req.open('get',url2+qry);
          req.send();
      });




      //3 동 출력 //***
        //함수생성해서 여기에 갖다 놓는다 셋동함수는 이벤트리슨어가 있고
      //XMLHttpRequest()가 있는 곳에서 setDong(req.responseText);로 쓰고
      //거기서 알트앤터 눌러 화살표 함수 선택하고 전역으로 설정해서 함수 생성해서
      //여기 (동)에서 갖다놓고 쓰면된다
      const setDong = (dongs) => {
          let  cols=dongs.split(',');
          while (dong.lastChild) {
              dong.removeChild(dong.lastChild);
          }

          makeopt(dong,'읍/면/동');
          for (let  col of cols){
              if (col =='') continue;
              makeopt(dong,col);
          }

      };




      //*** dong이벤트처리
      dong.addEventListener('change',()=>{
          let qry ='?dong='+ dong.value;
          //선택한시도가 '광역시라면' 함수 실행중지
          if(dong.selectedIndex==0) return;

          let req=new XMLHttpRequest();
          req.onreadystatechange = () => {
              if(req.readyState==4&& req.status==200){
                  //console.log(req.responseText);
                  setDong(req.responseText);


              }
          };
          req.open('get',url2+qry);
          req.send();
      });



      //코드 실행 -실행 진입점entry point,시작점
      getSido();


  </script>
  </body>
</html>
